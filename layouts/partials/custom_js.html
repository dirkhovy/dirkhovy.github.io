{{/* Custom JavaScript to ensure theme switching works */}}
<script>
  // Wait for jQuery and Academic JS to be fully loaded
  (function() {
    function initThemeSwitcher() {
      // Check if jQuery and required functions are available
      if (typeof jQuery === 'undefined' || typeof changeThemeModeClick === 'undefined') {
        console.log('Waiting for dependencies...');
        setTimeout(initThemeSwitcher, 100);
        return;
      }
      
      var $ = jQuery;
      
      // Remove any existing handlers and add new ones with event delegation
      $(document).off('click', '.js-set-theme-light');
      $(document).off('click', '.js-set-theme-dark');
      $(document).off('click', '.js-set-theme-auto');
      
      $(document).on('click', '.js-set-theme-light', function (e) {
        e.preventDefault();
        e.stopPropagation();
        // Don't use stopImmediatePropagation() as it breaks Bootstrap dropdowns
        console.log('Light theme clicked - custom handler');
        try {
          if (typeof changeThemeModeClick === 'function') {
            changeThemeModeClick(2);
          } else {
            // Fallback: directly set theme
            localStorage.setItem('dark_mode', '0');
            $('body').removeClass('dark');
            location.reload();
          }
        } catch(err) {
          console.error('Error changing theme:', err);
        }
        // Close dropdown manually for Firefox compatibility
        $(this).closest('.dropdown').removeClass('show');
        $(this).closest('.dropdown-menu').removeClass('show');
        return false;
      });
      
      $(document).on('click', '.js-set-theme-dark', function (e) {
        e.preventDefault();
        e.stopPropagation();
        // Don't use stopImmediatePropagation() as it breaks Bootstrap dropdowns
        console.log('Dark theme clicked - custom handler');
        try {
          if (typeof changeThemeModeClick === 'function') {
            changeThemeModeClick(0);
          } else {
            // Fallback: directly set theme
            localStorage.setItem('dark_mode', '1');
            $('body').addClass('dark');
            location.reload();
          }
        } catch(err) {
          console.error('Error changing theme:', err);
        }
        // Close dropdown manually for Firefox compatibility
        $(this).closest('.dropdown').removeClass('show');
        $(this).closest('.dropdown-menu').removeClass('show');
        return false;
      });
      
      $(document).on('click', '.js-set-theme-auto', function (e) {
        e.preventDefault();
        e.stopPropagation();
        // Don't use stopImmediatePropagation() as it breaks Bootstrap dropdowns
        console.log('Auto theme clicked - custom handler');
        try {
          if (typeof changeThemeModeClick === 'function') {
            changeThemeModeClick(1);
          } else {
            // Fallback: directly set theme
            localStorage.setItem('dark_mode', '2');
            location.reload();
          }
        } catch(err) {
          console.error('Error changing theme:', err);
        }
        // Close dropdown manually for Firefox compatibility
        $(this).closest('.dropdown').removeClass('show');
        $(this).closest('.dropdown-menu').removeClass('show');
        return false;
      });
      
      console.log('Theme switcher handlers attached');
    }
    
    // Start initialization - wait for both DOM and jQuery/Academic JS
    function startInit() {
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function() {
          setTimeout(initThemeSwitcher, 100);
        });
      } else {
        setTimeout(initThemeSwitcher, 100);
      }
    }
    startInit();
  })();
</script>
